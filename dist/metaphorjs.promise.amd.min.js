define("metaphorjs-promise",function(){var h=function(f){return"function"===typeof f},n=function(f){var d;return f&&(null!=f&&"object"===typeof f||h(f))?h(d=f.then)?d:!1:!1},d=Function.prototype.bind?function(f,d){return f.bind(d)}:function(d,h){return function(){return d.apply(h,arguments)}};return function(){var f=[],q=!1,s="undefined"!=typeof process?process.nextTick:function(a){setTimeout(a,0)},r=function(){q=!0;var a=f.shift();s(function(){a[0].apply(a[1],a[2]);f.length?r():q=!1},0)},l=function(a,
b,c){c=c||[];f.push([a,b,c]);q||r()},p=function(a,b){return function(c){try{b.resolve(a(c))}catch(e){b.reject(e)}}},e=function(a,b){if(a instanceof e)return a;if(!(this instanceof e))return new e(a,b);this._fulfills=[];this._rejects=[];this._dones=[];this._fails=[];if("undefined"!=typeof a)if(n(a)||!h(a))this.resolve(a);else try{a.call(b,d(this.resolve,this),d(this.reject,this))}catch(c){this.reject(c)}};e.prototype={_state:0,_fulfills:null,_rejects:null,_dones:null,_fails:null,_wait:0,_value:null,
_reason:null,_triggered:!1,isPending:function(){return 0==this._state},isFulfilled:function(){return 1==this._state},isRejected:function(){return 2==this._state},_cleanup:function(){delete this._fulfills;delete this._rejects;delete this._dones;delete this._fails},_processValue:function(a,b){var c;if(0==this._state)if(a===this)this._doReject(new TypeError("cannot resolve promise with itself"));else{try{if(c=n(a)){a instanceof e?a.then(d(this._processResolveValue,this),d(this._processRejectReason,this)):
(new e(c,a)).then(d(this._processResolveValue,this),d(this._processRejectReason,this));return}}catch(t){0==this._state&&this._doReject(t);return}b.call(this,a)}},_callResolveHandlers:function(){this._done();for(var a=this._fulfills,b;b=a.shift();)l(b[0],b[1],[this._value]);this._cleanup()},_doResolve:function(a){this._value=a;this._state=1;0==this._wait&&this._callResolveHandlers()},_processResolveValue:function(a){this._processValue(a,this._doResolve)},resolve:function(a){if(this._triggered)return this;
this._triggered=!0;this._processResolveValue(a);return this},_callRejectHandlers:function(){this._fail();for(var a=this._rejects,b;b=a.shift();)l(b[0],b[1],[this._reason]);this._cleanup()},_doReject:function(a){this._state=2;this._reason=a;0==this._wait&&this._callRejectHandlers()},_processRejectReason:function(a){this._processValue(a,this._doReject)},reject:function(a){if(this._triggered)return this;this._triggered=!0;this._processRejectReason(a);return this},then:function(a,b){var c=new e,d=this._state;
0==d||0!=this._wait?(a&&h(a)?this._fulfills.push([p(a,c),null]):this._fulfills.push([c.resolve,c]),b&&h(b)?this._rejects.push([p(b,c),null]):this._rejects.push([c.reject,c])):1==d?a&&h(a)?l(p(a,c),null,[this._value]):c.resolve(this._value):2==d&&(b&&h(b)?l(p(b,c),null,[this._reason]):c.reject(this._reason));return c},"catch":function(a){return this.then(null,a)},_done:function(){for(var a=this._dones,b;b=a.shift();)b[0].call(b[1]||null,this._value)},done:function(a,b){var c=this._state;1==c&&0==this._wait?
a.call(b||null,this._value):0==c&&this._dones.push([a,b]);return this},_fail:function(){for(var a=this._fails,b;b=a.shift();)b[0].call(b[1]||null,this._reason)},fail:function(a,b){var c=this._state;2==c&&0==this._wait?a.call(b||null,this._reason):0==c&&this._fails.push([a,b]);return this},always:function(a,b){this.done(a,b);this.fail(a,b);return this},promise:function(){return{then:d(this.then,this),done:d(this.done,this),fail:d(this.fail,this),always:d(this.always,this)}},after:function(a){var b=
this;if(n(a)){b._wait++;var c=function(){b._wait--;0==b._wait&&0!=b._state&&(1==b._state?b._callResolveHandlers():b._callRejectHandlers())};h(a.done)?a.done(c):a.then(c)}return b}};e.resolve=function(a){return new e(a)};e.reject=function(a){var b=new e;b.reject(a);return b};e.all=function(a){if(!a.length)return e.resolve(null);var b=new e,c=a.length,d=Array(c),f=c,k,g,m=function(a,c){d[c]=a;f--;0==f&&b.resolve(d)};for(k=0;k<c;k++)(function(c){g=a[k];g instanceof e?g.done(function(a){m(a,c)}).fail(b.reject,
b):n(g)||h(g)?(new e(g)).done(function(a){m(a,c)}).fail(b.reject,b):m(g,c)})(k);return b};e.when=function(){return e.all(arguments)};e.allResolved=function(a){if(!a.length)return e.resolve(null);var b=new e,c=a.length,d=[],f=c,k,g,m=function(a){d.push(a);l()},l=function(){f--;0==f&&b.resolve(d)};for(k=0;k<c;k++)g=a[k],g instanceof e?g.done(m).fail(l):n(g)||h(g)?(new e(g)).done(m).fail(l):m(g);return b};e.race=function(a){if(!a.length)return e.resolve(null);var b=new e,c=a.length,d,f;for(d=0;d<c&&
(f=a[d],f instanceof e?f.done(b.resolve,b).fail(b.reject,b):n(f)||h(f)?(new e(f)).done(b.resolve,b).fail(b.reject,b):b.resolve(f),b.isPending());d++);return b};return e}()});

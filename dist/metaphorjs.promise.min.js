'use strict';(function(){function m(e){return"function"==typeof e}function n(e){if(!e)return!1;var h,g;return"object"!=(g=typeof e)&&"function"!=g?!1:m(h=e.then)?h:!1}function t(e,h,g,f){setTimeout(function(){e.apply(h,g||[])},f||0)}function q(e){var h=e.stack||Error().stack;if("undefined"!=typeof console&&console.log)t(function(){console.log(e);h&&console.log(h)});else throw e;}function p(e){return"object"==typeof e&&3===u(e)&&!e.nodeType&&e.constructor===Object}function s(e){return!0===e||!1===
e}var r={},f=Function.prototype.bind?function(e,h){return e.bind(h)}:function(e,h){return function(){return e.apply(h,arguments)}},v=Array.prototype.slice,w=Object.prototype.toString,u=function(){var e={"[object String]":0,"[object Number]":1,"[object Boolean]":2,"[object Object]":3,"[object Function]":4,"[object Array]":5,"[object RegExp]":9,"[object Date]":10};return function(h){if(!h){if(null===h)return 6;if(void 0===h)return 7}var g=e[w.call(h)];return void 0===g?-1:1==g&&isNaN(h)?8:g}}(),x=function(){return function h(){var g=
!1,f=!1,l=v.call(arguments),k=l.shift(),d,a,b;s(l[l.length-1])&&(g=l.pop());s(l[l.length-1])&&(f=g,g=l.pop());for(;l.length;)if(d=l.shift())for(a in d)if(d.hasOwnProperty(a)&&void 0!==(b=d[a]))if(f)if(k[a]&&p(k[a])&&p(b))h(k[a],b,g,f);else{if(!0===g||void 0==k[a])p(b)?(k[a]={},h(k[a],b,g,!0)):k[a]=b}else if(!0===g||void 0==k[a])k[a]=b;return k}}(),y=function(){var e=[],h=!1,g="undefined"!=typeof process?process.nextTick:function(a){setTimeout(a,0)},p=function(){h=!0;var a=e.shift();g(function(){a[0].apply(a[1],
a[2]);e.length?p():h=!1},0)},l=function(a,b,c){c=c||[];e.push([a,b,c]);h||p()},k=function(a,b){return function(c){try{b.resolve(a(c))}catch(d){b.reject(d)}}},d=function(a,b){if(a instanceof d)return a;if(!(this instanceof d))return new d(a,b);var c;this._fulfills=[];this._rejects=[];this._dones=[];this._fails=[];if(0<arguments.length)if(c=n(a))a instanceof d?a.then(f(this.resolve,this),f(this.reject,this)):(new d(c,a)).then(f(this.resolve,this),f(this.reject,this));else if(m(a))try{a.call(b,f(this.resolve,
this),f(this.reject,this))}catch(e){this.reject(e)}else this.resolve(a)};x(d.prototype,{_state:0,_fulfills:null,_rejects:null,_dones:null,_fails:null,_wait:0,_value:null,_reason:null,_triggered:!1,isPending:function(){return 0==this._state},isFulfilled:function(){return 1==this._state},isRejected:function(){return 2==this._state},_cleanup:function(){this._fails=this._dones=this._rejects=this._fulfills=null},_processValue:function(a,b){var c;if(0==this._state)if(a===this)this._doReject(new TypeError("cannot resolve promise with itself"));
else{try{if(c=n(a)){a instanceof d?a.then(f(this._processResolveValue,this),f(this._processRejectReason,this)):(new d(c,a)).then(f(this._processResolveValue,this),f(this._processRejectReason,this));return}}catch(e){0==this._state&&this._doReject(e);return}b.call(this,a)}},_callResolveHandlers:function(){this._done();for(var a=this._fulfills,b;b=a.shift();)l(b[0],b[1],[this._value]);this._cleanup()},_doResolve:function(a){this._value=a;this._state=1;0==this._wait&&this._callResolveHandlers()},_processResolveValue:function(a){this._processValue(a,
this._doResolve)},resolve:function(a){if(this._triggered)return this;this._triggered=!0;this._processResolveValue(a);return this},_callRejectHandlers:function(){this._fail();for(var a=this._rejects,b;b=a.shift();)l(b[0],b[1],[this._reason]);this._cleanup()},_doReject:function(a){this._state=2;this._reason=a;0==this._wait&&this._callRejectHandlers()},_processRejectReason:function(a){this._processValue(a,this._doReject)},reject:function(a){if(this._triggered)return this;this._triggered=!0;this._processRejectReason(a);
return this},then:function(a,b){var c=new d,e=this._state;0==e||0!=this._wait?(a&&m(a)?this._fulfills.push([k(a,c),null]):this._fulfills.push([c.resolve,c]),b&&m(b)?this._rejects.push([k(b,c),null]):this._rejects.push([c.reject,c])):1==e?a&&m(a)?l(k(a,c),null,[this._value]):c.resolve(this._value):2==e&&(b&&m(b)?l(k(b,c),null,[this._reason]):c.reject(this._reason));return c},"catch":function(a){return this.then(null,a)},_done:function(){for(var a=this._dones,b;b=a.shift();)try{b[0].call(b[1]||null,
this._value)}catch(c){q(c)}},done:function(a,b){var c=this._state;if(1==c&&0==this._wait)try{a.call(b||null,this._value)}catch(d){q(d)}else 0==c&&this._dones.push([a,b]);return this},_fail:function(){for(var a=this._fails,b;b=a.shift();)try{b[0].call(b[1]||null,this._reason)}catch(c){q(c)}},fail:function(a,b){var c=this._state;if(2==c&&0==this._wait)try{a.call(b||null,this._reason)}catch(d){q(d)}else 0==c&&this._fails.push([a,b]);return this},always:function(a,b){this.done(a,b);this.fail(a,b);return this},
promise:function(){return{then:f(this.then,this),done:f(this.done,this),fail:f(this.fail,this),always:f(this.always,this)}},after:function(a){var b=this;if(n(a)){b._wait++;var c=function(){b._wait--;0==b._wait&&0!=b._state&&(1==b._state?b._callResolveHandlers():b._callRejectHandlers())};m(a.done)?a.done(c):a.then(c)}return b}},!0,!1);d.fcall=function(a,b,c){return d.resolve(a.apply(b,c||[]))};d.resolve=function(a){var b=new d;b.resolve(a);return b};d.reject=function(a){var b=new d;b.reject(a);return b};
d.all=function(a){if(!a.length)return d.resolve(null);var b=new d,c=a.length,e=Array(c),h=c,f,g,k=function(a,c){e[c]=a;h--;0==h&&b.resolve(e)};for(f=0;f<c;f++)(function(c){g=a[f];g instanceof d?g.done(function(a){k(a,c)}).fail(b.reject,b):n(g)||m(g)?(new d(g)).done(function(a){k(a,c)}).fail(b.reject,b):k(g,c)})(f);return b};d.when=function(){return d.all(arguments)};d.allResolved=function(a){if(!a.length)return d.resolve(null);var b=new d,c=a.length,e=[],h=c,g,f,k=function(a){e.push(a);l()},l=function(){h--;
0==h&&b.resolve(e)};for(g=0;g<c;g++)f=a[g],f instanceof d?f.done(k).fail(l):n(f)||m(f)?(new d(f)).done(k).fail(l):k(f);return b};d.race=function(a){if(!a.length)return d.resolve(null);var b=new d,c=a.length,e,f;for(e=0;e<c&&(f=a[e],f instanceof d?f.done(b.resolve,b).fail(b.reject,b):n(f)||m(f)?(new d(f)).done(b.resolve,b).fail(b.reject,b):b.resolve(f),b.isPending());e++);return b};d.waterfall=function(a){if(!a.length)return d.resolve(null);for(var b=a.shift(),b=m(b)?d.fcall(b):d.resolve(c),c;c=a.shift();)n(c)?
b=b.then(function(a){return function(){return a}}(c)):m(c)?b=b.then(c):b.resolve(c);return b};d.counter=function(a){var b=new d;b.countdown=function(){a--;0==a&&b.resolve()};return b};return d}();r.Promise=y;"undefined"!=typeof global?global.MetaphorJs=r:window.MetaphorJs=r})();

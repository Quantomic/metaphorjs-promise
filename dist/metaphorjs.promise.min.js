(function(){var l={lib:{},cmp:{},view:{}},k=function(d){return"function"==typeof d},s=Object.prototype.toString,t=function(){var d={"[object String]":0,"[object Number]":1,"[object Boolean]":2,"[object Object]":3,"[object Function]":4,"[object Array]":5,"[object RegExp]":9,"[object Date]":10};return function(g){if(!g){if(null===g)return 6;if(void 0===g)return 7}var f=d[s.call(g)];return void 0===f?-1:1==f&&isNaN(g)?8:f}}(),n=function(d){var g,f;(f=!d)||(null===d||"object"!=typeof d?f=!1:(f=t(d),f=
2<f||-1==f),f=!f&&!k(d));return f?!1:k(g=d.then)?g:!1},h=Function.prototype.bind?function(d,g){return d.bind(g)}:function(d,g){return function(){return d.apply(g,arguments)}},u=function(d,g,f){setTimeout(function(){d.apply(g,f||[])},0)},r=function(d){var g=d.stack||Error().stack;if("undefined"!=typeof console&&console.log)u(function(){console.log(d);g&&console.log(g)});else throw d;},v=function(){var d=[],g=!1,f="undefined"!=typeof process?process.nextTick:function(a){setTimeout(a,0)},l=function(){g=
!0;var a=d.shift();f(function(){a[0].apply(a[1],a[2]);d.length?l():g=!1},0)},m=function(a,b,c){c=c||[];d.push([a,b,c]);g||l()},q=function(a,b){return function(c){try{b.resolve(a(c))}catch(e){b.reject(e)}}},e=function(a,b){if(a instanceof e)return a;if(!(this instanceof e))return new e(a,b);var c;this._fulfills=[];this._rejects=[];this._dones=[];this._fails=[];if(0<arguments.length)if(c=n(a))a instanceof e?a.then(h(this.resolve,this),h(this.reject,this)):(new e(c,a)).then(h(this.resolve,this),h(this.reject,
this));else if(k(a))try{a.call(b,h(this.resolve,this),h(this.reject,this))}catch(d){this.reject(d)}else this.resolve(a)};e.prototype={_state:0,_fulfills:null,_rejects:null,_dones:null,_fails:null,_wait:0,_value:null,_reason:null,_triggered:!1,isPending:function(){return 0==this._state},isFulfilled:function(){return 1==this._state},isRejected:function(){return 2==this._state},_cleanup:function(){delete this._fulfills;delete this._rejects;delete this._dones;delete this._fails},_processValue:function(a,
b){var c;if(0==this._state)if(a===this)this._doReject(new TypeError("cannot resolve promise with itself"));else{try{if(c=n(a)){a instanceof e?a.then(h(this._processResolveValue,this),h(this._processRejectReason,this)):(new e(c,a)).then(h(this._processResolveValue,this),h(this._processRejectReason,this));return}}catch(d){0==this._state&&this._doReject(d);return}b.call(this,a)}},_callResolveHandlers:function(){this._done();for(var a=this._fulfills,b;b=a.shift();)m(b[0],b[1],[this._value]);this._cleanup()},
_doResolve:function(a){this._value=a;this._state=1;0==this._wait&&this._callResolveHandlers()},_processResolveValue:function(a){this._processValue(a,this._doResolve)},resolve:function(a){if(this._triggered)return this;this._triggered=!0;this._processResolveValue(a);return this},_callRejectHandlers:function(){this._fail();for(var a=this._rejects,b;b=a.shift();)m(b[0],b[1],[this._reason]);this._cleanup()},_doReject:function(a){this._state=2;this._reason=a;0==this._wait&&this._callRejectHandlers()},
_processRejectReason:function(a){this._processValue(a,this._doReject)},reject:function(a){if(this._triggered)return this;this._triggered=!0;this._processRejectReason(a);return this},then:function(a,b){var c=new e,d=this._state;0==d||0!=this._wait?(a&&k(a)?this._fulfills.push([q(a,c),null]):this._fulfills.push([c.resolve,c]),b&&k(b)?this._rejects.push([q(b,c),null]):this._rejects.push([c.reject,c])):1==d?a&&k(a)?m(q(a,c),null,[this._value]):c.resolve(this._value):2==d&&(b&&k(b)?m(q(b,c),null,[this._reason]):
c.reject(this._reason));return c},"catch":function(a){return this.then(null,a)},_done:function(){for(var a=this._dones,b;b=a.shift();)try{b[0].call(b[1]||null,this._value)}catch(c){r(c)}},done:function(a,b){var c=this._state;1==c&&0==this._wait?a.call(b||null,this._value):0==c&&this._dones.push([a,b]);return this},_fail:function(){for(var a=this._fails,b;b=a.shift();)try{b[0].call(b[1]||null,this._reason)}catch(c){r(c)}},fail:function(a,b){var c=this._state;2==c&&0==this._wait?a.call(b||null,this._reason):
0==c&&this._fails.push([a,b]);return this},always:function(a,b){this.done(a,b);this.fail(a,b);return this},promise:function(){return{then:h(this.then,this),done:h(this.done,this),fail:h(this.fail,this),always:h(this.always,this)}},after:function(a){var b=this;if(n(a)){b._wait++;var c=function(){b._wait--;0==b._wait&&0!=b._state&&(1==b._state?b._callResolveHandlers():b._callRejectHandlers())};k(a.done)?a.done(c):a.then(c)}return b}};e.fcall=function(a,b,c){return e.resolve(a.apply(b,c||[]))};e.resolve=
function(a){var b=new e;b.resolve(a);return b};e.reject=function(a){var b=new e;b.reject(a);return b};e.all=function(a){if(!a.length)return e.resolve(null);var b=new e,c=a.length,d=Array(c),g=c,f,p,h=function(a,c){d[c]=a;g--;0==g&&b.resolve(d)};for(f=0;f<c;f++)(function(c){p=a[f];p instanceof e?p.done(function(a){h(a,c)}).fail(b.reject,b):n(p)||k(p)?(new e(p)).done(function(a){h(a,c)}).fail(b.reject,b):h(p,c)})(f);return b};e.when=function(){return e.all(arguments)};e.allResolved=function(a){if(!a.length)return e.resolve(null);
var b=new e,c=a.length,d=[],g=c,f,h,l=function(a){d.push(a);m()},m=function(){g--;0==g&&b.resolve(d)};for(f=0;f<c;f++)h=a[f],h instanceof e?h.done(l).fail(m):n(h)||k(h)?(new e(h)).done(l).fail(m):l(h);return b};e.race=function(a){if(!a.length)return e.resolve(null);var b=new e,c=a.length,d,f;for(d=0;d<c&&(f=a[d],f instanceof e?f.done(b.resolve,b).fail(b.reject,b):n(f)||k(f)?(new e(f)).done(b.resolve,b).fail(b.reject,b):b.resolve(f),b.isPending());d++);return b};e.waterfall=function(a){if(!a.length)return e.resolve(null);
for(var b=a.shift(),b=k(b)?e.fcall(b):e.resolve(c),c;c=a.shift();)n(c)?b=b.then(function(a){return function(){return a}}(c)):k(c)?b=b.then(c):b.resolve(c);return b};e.counter=function(a){var b=new e;b.countdown=function(){a--;0==a&&b.resolve()};return b};return e}();l.lib.Promise=v;"undefined"!=typeof global?global.MetaphorJs=l:window.MetaphorJs=l})();

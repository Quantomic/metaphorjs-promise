(function(){window.MetaphorJs={lib:{}};var l=MetaphorJs.isThenable=function(f){var d;return!f||"object"!=typeof f&&"function"!=typeof f?!1:"function"==typeof(d=f.then)?d:!1},d=MetaphorJs.bind=Function.prototype.bind?function(d,h){return d.bind(h)}:function(d,h){return function(){return d.apply(h,arguments)}};(function(){var f=[],h=!1,r="undefined"!=typeof process?process.nextTick:function(a){setTimeout(a,0)},q=function(){h=!0;var a=f.shift();r(function(){a[0].apply(a[1],a[2]);f.length?q():h=!1},0)},
k=function(a,b,c){c=c||[];f.push([a,b,c]);h||q()},p=function(a,b){return function(c){try{b.resolve(a(c))}catch(e){b.reject(e)}}},e=function(a,b){if(a instanceof e)return a;if(!(this instanceof e))return new e(a,b);this._fulfills=[];this._rejects=[];this._dones=[];this._fails=[];if("undefined"!=typeof a)if(l(a)||"function"!=typeof a)this.resolve(a);else try{a.call(b,d(this.resolve,this),d(this.reject,this))}catch(c){this.reject(c)}};e.prototype={_state:0,_fulfills:null,_rejects:null,_dones:null,_fails:null,
_wait:0,_value:null,_reason:null,_triggered:!1,isPending:function(){return 0==this._state},isFulfilled:function(){return 1==this._state},isRejected:function(){return 2==this._state},_cleanup:function(){delete this._fulfills;delete this._rejects;delete this._dones;delete this._fails},_processValue:function(a,b){var c;if(0==this._state)if(a===this)this._doReject(new TypeError("cannot resolve promise with itself"));else{try{if(c=l(a)){a instanceof e?a.then(d(this._processResolveValue,this),d(this._processRejectReason,
this)):(new e(c,a)).then(d(this._processResolveValue,this),d(this._processRejectReason,this));return}}catch(s){0==this._state&&this._doReject(s);return}b.call(this,a)}},_callResolveHandlers:function(){this._done();for(var a=this._fulfills,b;b=a.shift();)k(b[0],b[1],[this._value]);this._cleanup()},_doResolve:function(a){this._value=a;this._state=1;0==this._wait&&this._callResolveHandlers()},_processResolveValue:function(a){this._processValue(a,this._doResolve)},resolve:function(a){if(this._triggered)return this;
this._triggered=!0;this._processResolveValue(a);return this},_callRejectHandlers:function(){this._fail();for(var a=this._rejects,b;b=a.shift();)k(b[0],b[1],[this._reason]);this._cleanup()},_doReject:function(a){this._state=2;this._reason=a;0==this._wait&&this._callRejectHandlers()},_processRejectReason:function(a){this._processValue(a,this._doReject)},reject:function(a){if(this._triggered)return this;this._triggered=!0;this._processRejectReason(a);return this},then:function(a,b){var c=new e,d=this._state;
0==d||0!=this._wait?(a&&"function"==typeof a?this._fulfills.push([p(a,c),null]):this._fulfills.push([c.resolve,c]),b&&"function"==typeof b?this._rejects.push([p(b,c),null]):this._rejects.push([c.reject,c])):1==d?a&&"function"==typeof a?k(p(a,c),null,[this._value]):c.resolve(this._value):2==d&&(b&&"function"==typeof b?k(p(b,c),null,[this._reason]):c.reject(this._reason));return c},"catch":function(a){return this.then(null,a)},_done:function(){for(var a=this._dones,b;b=a.shift();)b[0].call(b[1]||null,
this._value)},done:function(a,b){var c=this._state;1==c&&0==this._wait?a.call(b||null,this._value):0==c&&this._dones.push([a,b]);return this},_fail:function(){for(var a=this._fails,b;b=a.shift();)b[0].call(b[1]||null,this._reason)},fail:function(a,b){var c=this._state;2==c&&0==this._wait?a.call(b||null,this._reason):0==c&&this._fails.push([a,b]);return this},always:function(a,b){this.done(a,b);this.fail(a,b);return this},promise:function(){return{then:d(this.then,this),done:d(this.done,this),fail:d(this.fail,
this),always:d(this.always,this)}},after:function(a){var b=this;if(l(a)){b._wait++;var c=function(){b._wait--;0==b._wait&&0!=b._state&&(1==b._state?b._callResolveHandlers():b._callRejectHandlers())};"function"==typeof a.done?a.done(c):a.then(c)}return b}};e.resolve=function(a){return new e(a)};e.reject=function(a){var b=new e;b.reject(a);return b};e.all=function(a){if(!a.length)return e.resolve(null);var b=new e,c=a.length,d=Array(c),m=c,n,g,f=function(a,c){d[c]=a;m--;0==m&&b.resolve(d)};for(n=0;n<
c;n++)(function(c){g=a[n];g instanceof e?g.done(function(a){f(a,c)}).fail(b.reject,b):l(g)||"function"==typeof g?(new e(g)).done(function(a){f(a,c)}).fail(b.reject,b):f(g,c)})(n);return b};e.when=function(){return e.all(arguments)};e.allResolved=function(a){if(!a.length)return e.resolve(null);var b=new e,c=a.length,d=[],m=c,f,g,h=function(a){d.push(a);k()},k=function(){m--;0==m&&b.resolve(d)};for(f=0;f<c;f++)g=a[f],g instanceof e?g.done(h).fail(k):l(g)||"function"==typeof g?(new e(g)).done(h).fail(k):
h(g);return b};e.race=function(a){if(!a.length)return e.resolve(null);var b=new e,c=a.length,d,f;for(d=0;d<c&&(f=a[d],f instanceof e?f.done(b.resolve,b).fail(b.reject,b):l(f)||"function"==typeof f?(new e(f)).done(b.resolve,b).fail(b.reject,b):b.resolve(f),b.isPending());d++);return b};MetaphorJs.lib.Promise=e})()})();

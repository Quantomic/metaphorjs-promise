(function(){var q={lib:{},cmp:{},view:{}},g=function(f){return"function"==typeof f},m=function(f){if(!f||!f.then)return!1;var k,e;return"object"!=(e=typeof f)&&"function"!=e?!1:g(k=f.then)?k:!1},e=Function.prototype.bind?function(f,e){return f.bind(e)}:function(f,e){return function(){return f.apply(e,arguments)}},v=function(e,g,m,p){setTimeout(function(){e.apply(g,m||[])},p||0)},p=function(e){var g=e.stack||Error().stack;if("undefined"!=typeof console&&console.log)v(function(){console.log(e);g&&console.log(g)});
else throw e;},w=function(){var f=[],k=!1,q="undefined"!=typeof process?process.nextTick:function(a){setTimeout(a,0)},u=function(){k=!0;var a=f.shift();q(function(){a[0].apply(a[1],a[2]);f.length?u():k=!1},0)},r=function(a,b,c){c=c||[];f.push([a,b,c]);k||u()},s=function(a,b){return function(c){try{b.resolve(a(c))}catch(d){b.reject(d)}}},d=function(a,b){if(a instanceof d)return a;if(!(this instanceof d))return new d(a,b);var c;this._fulfills=[];this._rejects=[];this._dones=[];this._fails=[];if(0<arguments.length)if(c=
m(a))a instanceof d?a.then(e(this.resolve,this),e(this.reject,this)):(new d(c,a)).then(e(this.resolve,this),e(this.reject,this));else if(g(a))try{a.call(b,e(this.resolve,this),e(this.reject,this))}catch(t){this.reject(t)}else this.resolve(a)};d.prototype={_state:0,_fulfills:null,_rejects:null,_dones:null,_fails:null,_wait:0,_value:null,_reason:null,_triggered:!1,isPending:function(){return 0==this._state},isFulfilled:function(){return 1==this._state},isRejected:function(){return 2==this._state},_cleanup:function(){delete this._fulfills;
delete this._rejects;delete this._dones;delete this._fails},_processValue:function(a,b){var c;if(0==this._state)if(a===this)this._doReject(new TypeError("cannot resolve promise with itself"));else{try{if(c=m(a)){a instanceof d?a.then(e(this._processResolveValue,this),e(this._processRejectReason,this)):(new d(c,a)).then(e(this._processResolveValue,this),e(this._processRejectReason,this));return}}catch(t){0==this._state&&this._doReject(t);return}b.call(this,a)}},_callResolveHandlers:function(){this._done();
for(var a=this._fulfills,b;b=a.shift();)r(b[0],b[1],[this._value]);this._cleanup()},_doResolve:function(a){this._value=a;this._state=1;0==this._wait&&this._callResolveHandlers()},_processResolveValue:function(a){this._processValue(a,this._doResolve)},resolve:function(a){if(this._triggered)return this;this._triggered=!0;this._processResolveValue(a);return this},_callRejectHandlers:function(){this._fail();for(var a=this._rejects,b;b=a.shift();)r(b[0],b[1],[this._reason]);this._cleanup()},_doReject:function(a){this._state=
2;this._reason=a;0==this._wait&&this._callRejectHandlers()},_processRejectReason:function(a){this._processValue(a,this._doReject)},reject:function(a){if(this._triggered)return this;this._triggered=!0;this._processRejectReason(a);return this},then:function(a,b){var c=new d,e=this._state;0==e||0!=this._wait?(a&&g(a)?this._fulfills.push([s(a,c),null]):this._fulfills.push([c.resolve,c]),b&&g(b)?this._rejects.push([s(b,c),null]):this._rejects.push([c.reject,c])):1==e?a&&g(a)?r(s(a,c),null,[this._value]):
c.resolve(this._value):2==e&&(b&&g(b)?r(s(b,c),null,[this._reason]):c.reject(this._reason));return c},"catch":function(a){return this.then(null,a)},_done:function(){for(var a=this._dones,b;b=a.shift();)try{b[0].call(b[1]||null,this._value)}catch(c){p(c)}},done:function(a,b){var c=this._state;if(1==c&&0==this._wait)try{a.call(b||null,this._value)}catch(d){p(d)}else 0==c&&this._dones.push([a,b]);return this},_fail:function(){for(var a=this._fails,b;b=a.shift();)try{b[0].call(b[1]||null,this._reason)}catch(c){p(c)}},
fail:function(a,b){var c=this._state;if(2==c&&0==this._wait)try{a.call(b||null,this._reason)}catch(d){p(d)}else 0==c&&this._fails.push([a,b]);return this},always:function(a,b){this.done(a,b);this.fail(a,b);return this},promise:function(){return{then:e(this.then,this),done:e(this.done,this),fail:e(this.fail,this),always:e(this.always,this)}},after:function(a){var b=this;if(m(a)){b._wait++;var c=function(){b._wait--;0==b._wait&&0!=b._state&&(1==b._state?b._callResolveHandlers():b._callRejectHandlers())};
g(a.done)?a.done(c):a.then(c)}return b}};d.fcall=function(a,b,c){return d.resolve(a.apply(b,c||[]))};d.resolve=function(a){var b=new d;b.resolve(a);return b};d.reject=function(a){var b=new d;b.reject(a);return b};d.all=function(a){if(!a.length)return d.resolve(null);var b=new d,c=a.length,e=Array(c),f=c,l,h,n=function(a,c){e[c]=a;f--;0==f&&b.resolve(e)};for(l=0;l<c;l++)(function(c){h=a[l];h instanceof d?h.done(function(a){n(a,c)}).fail(b.reject,b):m(h)||g(h)?(new d(h)).done(function(a){n(a,c)}).fail(b.reject,
b):n(h,c)})(l);return b};d.when=function(){return d.all(arguments)};d.allResolved=function(a){if(!a.length)return d.resolve(null);var b=new d,c=a.length,e=[],f=c,l,h,n=function(a){e.push(a);k()},k=function(){f--;0==f&&b.resolve(e)};for(l=0;l<c;l++)h=a[l],h instanceof d?h.done(n).fail(k):m(h)||g(h)?(new d(h)).done(n).fail(k):n(h);return b};d.race=function(a){if(!a.length)return d.resolve(null);var b=new d,c=a.length,e,f;for(e=0;e<c&&(f=a[e],f instanceof d?f.done(b.resolve,b).fail(b.reject,b):m(f)||
g(f)?(new d(f)).done(b.resolve,b).fail(b.reject,b):b.resolve(f),b.isPending());e++);return b};d.waterfall=function(a){if(!a.length)return d.resolve(null);for(var b=a.shift(),b=g(b)?d.fcall(b):d.resolve(c),c;c=a.shift();)m(c)?b=b.then(function(a){return function(){return a}}(c)):g(c)?b=b.then(c):b.resolve(c);return b};d.counter=function(a){var b=new d;b.countdown=function(){a--;0==a&&b.resolve()};return b};return d}();q.lib.Promise=w;"undefined"!=typeof global?global.MetaphorJs=q:window.MetaphorJs=
q})();
